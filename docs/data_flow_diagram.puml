@startuml SERS_Insight_Data_Flow

!define PRIMARY_COLOR #6366F1
!define SECONDARY_COLOR #06B6D4
!define ACCENT_COLOR #8B5CF6
!define SUCCESS_COLOR #10B981
!define WARNING_COLOR #F59E0B

skinparam backgroundColor #FAFAFA
skinparam defaultFontName Inter
skinparam defaultFontSize 10
skinparam shadowing true

skinparam activity {
    BackgroundColor white
    BorderColor PRIMARY_COLOR
    DiamondBackgroundColor #FEF3C7
    DiamondBorderColor WARNING_COLOR
}

skinparam swimlane {
    BorderColor #CBD5E1
    TitleFontSize 14
}

title <size:22><b>SERS-Insight Platform - Data Flow Diagram</b></size>\n<size:12>Complete Workflow from Data Input to Analysis Output</size>

|#EEF2FF|Frontend|
|#FEF2F2|Backend|
|#FDF4FF|Processing|
|#ECFDF5|Output|

|Frontend|
start
:ğŸ‘¤ **User Interaction**
Select module from sidebar;

fork
    :ğŸ“Š **AI Chat Analysis**
    Upload spectrum data;
    
    :ğŸ’¬ Enter analysis query
    (Natural language);
fork again
    :ğŸ”¬ **LSPR Simulation**
    Configure parameters;
    
    :âš™ï¸ Set:
    â€¢ Material (Ag/Au)
    â€¢ Shape (sphere/rod/star/cube)
    â€¢ Size (10-150nm)
    â€¢ Excitation wavelength;
fork again
    :ğŸ“ˆ **Peak Analyzer**
    Upload CSV/TXT file;
    
    :ğŸ“‹ Data Preview
    Select X & Y columns;
fork again
    :ğŸ“Š **Visualization**
    Load spectrum data;
    
    :ğŸ¨ Select chart type
    (spectrum/PCA/heatmap);
end fork

|Backend|

' ========== UPLOAD FLOW ==========
partition "**Data Upload Flow**" {
    :ğŸ“¤ POST /api/upload;
    
    :ğŸ” Detect file type
    (CSV/TXT/XLSX/JSON/Image);
    
    :ğŸ“‚ Save to uploads/
    (UUID filename);
    
    :ğŸ“Š Parse & extract metadata
    â€¢ Column names
    â€¢ Row count
    â€¢ Wavenumber range;
    
    :âœ… Return DatasetInfo;
}

' ========== PREPROCESS FLOW ==========
partition "**Preprocessing Pipeline**" {
    :âš™ï¸ POST /api/preprocess;
    
    |Processing|
    
    :ğŸ“¥ Load spectrum data
    (wavenumber[], intensity[]);
    
    if (Baseline Correction?) then (yes)
        :ğŸ”§ **ALS Algorithm**
        Îµ(Ï‰) baseline estimation
        --
        â€¢ Î» smoothness param
        â€¢ p asymmetry param;
        
        :â– Subtract baseline
        intensity = raw - baseline;
    endif
    
    if (Smoothing?) then (yes)
        :ğŸ“Š **Savitzky-Golay Filter**
        --
        â€¢ window_length (odd)
        â€¢ polyorder (1-5);
    endif
    
    if (Normalization?) then (yes)
        switch (Method?)
        case (vector)
            :Ã· ||y||â‚‚;
        case (max)
            :Ã· max(y);
        case (minmax)
            :(y - min) / (max - min);
        endswitch
    endif
    
    if (Peak Detection?) then (yes)
        :ğŸ” **find_peaks()**
        --
        â€¢ prominence threshold
        â€¢ minimum distance;
        
        :ğŸ“ Extract peak info:
        â€¢ Wavenumber position
        â€¢ Intensity
        â€¢ FWHM
        â€¢ Area;
    endif
    
    |Backend|
    :âœ… Return PreprocessResponse;
}

' ========== ANALYSIS FLOW ==========
partition "**Analysis Frameworks**" {
    :ğŸ”¬ POST /api/analyze;
    
    switch (Framework?)
    
    case (molecule_detection)
        |Processing|
        :ğŸ§ª **Molecule Detection**;
        
        :ğŸ“š Load reference library
        (R6G, CV, NB, MB peaks);
        
        :ğŸ¯ Peak matching
        tolerance = Â±15 cmâ»Â¹;
        
        :ğŸ“Š Calculate confidence
        matched_peaks / total_peaks;
        
        |Backend|
        :âœ… Detection result
        â€¢ Molecule name
        â€¢ Confidence score
        â€¢ Matched peaks;
        
    case (biomolecule_classification)
        |Processing|
        :ğŸ§¬ **PCA + Classification**;
        
        :ğŸ“‰ StandardScaler
        normalize features;
        
        :ğŸ“Š PCA reduction
        n_components = 5;
        
        if (Classifier?) then (SVM)
            :ğŸ¤– SVM (RBF kernel);
        else (RF)
            :ğŸŒ³ Random Forest
            n_estimators = 100;
        endif
        
        :âœ‚ï¸ Cross-validation
        k-fold = 5;
        
        |Backend|
        :âœ… Classification result
        â€¢ Accuracy
        â€¢ Precision/Recall
        â€¢ Confusion matrix;
        
    case (spectral_unmixing)
        |Processing|
        :ğŸ”€ **NMF/ICA Unmixing**;
        
        :ğŸ“Š Decompose spectra
        into components;
        
        |Backend|
        :âœ… Component spectra
        & concentrations;
    endswitch
}

' ========== SIMULATION FLOW ==========
partition "**LSPR Simulation**" {
    :âš¡ POST /api/simulate;
    
    |Processing|
    :âš›ï¸ **Drude-Lorentz Model**;
    
    :ğŸ“ Calculate dielectric function
    Îµ(Ï‰) = Îµâˆ - Ï‰â‚šÂ² / (Ï‰Â² + iÎ³Ï‰)
    --
    **Ag:** Îµâˆ=3.7, Ï‰â‚š=9.17eV, Î³=0.021eV
    **Au:** Îµâˆ=9.84, Ï‰â‚š=9.03eV, Î³=0.072eV;
    
    :ğŸ”® **Mie Theory**
    Calculate extinction;
    
    :ğŸ“ Determine LSPR peak
    Î»_LSPR = base + size_shift + shape_shift;
    
    :âœ¨ **Enhancement Factor**
    EF = |E_local/Eâ‚€|â´ âˆ |Î±|â´
    --
    Shape multipliers:
    â€¢ Sphere: 1.0Ã—
    â€¢ Rod: 2.5Ã— 
    â€¢ Star: 10.0Ã—
    â€¢ Cube: 1.5Ã—;
    
    :ğŸ“ Calculate FWHM
    Intrinsic + Radiative damping;
    
    :ğŸ’¡ Generate recommendation
    Based on wavelength matching;
    
    |Backend|
    :âœ… SimulateResponse
    â€¢ LSPR peak (nm)
    â€¢ Enhancement factor
    â€¢ FWHM
    â€¢ Extinction spectrum
    â€¢ Recommendation;
}

' ========== AI CHAT FLOW ==========
partition "**AI-Powered Chat**" {
    :ğŸ’¬ POST /api/chat/stream;
    
    :ğŸ”„ Format data context
    (spectrum stats, peak info);
    
    :ğŸ¤– Build SERS expert prompt;
    
    :ğŸ”— OpenRouter API call;
    
    fork
        :ğŸ¦™ Llama 3.3 70B
        (Primary);
    fork again
        :âœ¨ Gemini 2.0 Flash
        (Fallback 1);
    fork again
        :ğŸ¤– Qwen 2.5 72B
        (Fallback 2);
    end fork
    
    :ğŸ“¡ SSE Streaming response;
    
    |Output|
    :ğŸ’¬ Display AI response
    with markdown rendering;
}

' ========== OUTPUT FLOW ==========
|Output|

fork
    :ğŸ“Š **Interactive Charts**
    (Plotly.js visualization);
    
    :ğŸ–¼ï¸ Export options:
    â€¢ PNG
    â€¢ SVG
    â€¢ CSV data;
fork again
    :ğŸ“‹ **Results Panel**
    â€¢ Detected peaks table
    â€¢ Classification metrics
    â€¢ Parameters summary;
fork again
    :ğŸ’¾ **Download Results**
    Processed data export;
end fork

:âœ… **Analysis Complete**;

stop

legend right
    |= Symbol |= Description |
    | ğŸ“¤ | File Upload |
    | âš™ï¸ | Processing Step |
    | ğŸ”¬ | Analysis |
    | ğŸ¤– | AI/ML Model |
    | ğŸ“Š | Visualization |
    | âœ… | Output/Result |
endlegend

footer \n<size:10>SERS-Insight Platform - Data Processing Workflow v1.0.0</size>

@enduml
